
<template name="stagePage">
  {{>navbar}}
  {{setTitle this}}
  {{log this}}
  <div class="container-fluid">
    <h3>Details for Stage {{stage.id}}, Attempt {{stageAttempt.id}}</h3>
    {{#with stageAttempt.metrics}}
      <div><strong>Total time across all tasks:</strong> {{formatTime ExecutorRunTime}}</div>

      {{#with InputMetrics}}
        {{#if hasInput}}
        <div>
          <strong>Input Size / Records:</strong> {{formatBytes BytesRead}} / {{RecordsRead}} records
        </div>
        {{/if}}
      {{/with}}

      {{#with OutputMetrics}}
        {{#if hasOutput}}
        <div>
          <strong>Output Size / Records:</strong> {{formatBytes BytesWritten}} / {{RecordsWritten}} records
        </div>
        {{/if}}
      {{/with}}

      {{#with ShuffleReadMetrics}}
        {{#if hasShuffleRead}}
        <div>
          <strong>Shuffle read:</strong> {{shuffleBytesReadStr this}} / {{TotalRecordsRead}} records
        </div>
        {{/if}}
      {{/with}}

      {{#with ShuffleWriteMetrics}}
        {{#if hasShuffleWrite}}
        <div>
          <strong>Shuffle write:</strong> {{formatBytes ShuffleBytesWritten}} / {{ShuffleRecordsWritten}} records
        </div>
        {{/if}}
      {{/with}}
    {{/with}}

    {{> summaryMetricsTable this}}
    {{> executorTable this}}
    {{> tasksTable this}}
  </div>
</template>

<template name="summaryMetricsTable">
  {{#with stage.taskCounts}}
    <h4>
      Summary Metrics for {{numCompletedTasks this}} Completed Tasks
      ({{num}} total,
        {{running}} active,
        {{#if failed}}{{failed}}{{else}}0{{/if}} failed,
        {{#if succeeded}}{{succeeded}}{{else}}0{{/if}} succeeded)
    </h4>
  {{/with}}
  <table class="table table-bordered table-striped table-condensed sortable">
    <thead>
    <tr>
      <th>Metric</th>
      <th>Min</th>
      <th>25th Percentile</th>
      <th>Median</th>
      <th>75th Percentile</th>
      <th>Max</th>
    </tr>
    </thead>
    <tbody>
    {{> summaryRow durations}}
    </tbody>
  </table>
</template>

<template name="hostPort">
  {{host}}:{{port}}
</template>

<template name="summaryRow">
  <tr>
    <td>{{name}}</td>
    <td>{{stats.[0]}}</td>
    <td>{{stats.[1]}}</td>
    <td>{{stats.[2]}}</td>
    <td>{{stats.[3]}}</td>
    <td>{{stats.[4]}}</td>
  </tr>
</template>

<template name="executorTable">
  <h4>Aggregated Metrics by Executor</h4>
  <table class="table table-bordered table-striped table-condensed sortable">
    <thead>
    <tr>
      <th>Executor ID</th>
      <th>Address</th>
      <th>Task Time</th>
      <th>Active Tasks</th>
      <th>Failed Tasks</th>
      <th>Succeeded Tasks</th>
      <th>Total Tasks</th>
      {{>metricsHeaders}}
    </tr>
    </thead>
    <tbody>
    {{#each executors}}
      {{>executorRow}}
    {{/each}}
    </tbody>
  </table>
</template>

<template name="metricsHeaders">
  {{#if hasInput}}
    <th>Input Size</th>
    <th>…Records</th>
  {{/if}}
  {{#if hasOutput}}
    <th>Output Size</th>
    <th>…Records</th>
  {{/if}}
  {{#if hasShuffleRead}}
    <th>Shuffle Read Size</th>
    <th>…Records</th>
  {{/if}}
  {{#if hasShuffleWrite}}
    <th>Shuffle Write Size</th>
    <th>…Records</th>
  {{/if}}
</template>

<template name="metricsColumns">
  {{#if hasInput}}
    {{#with InputMetrics}}
      <td>{{formatBytes BytesRead}}</td>
      <td>{{RecordsRead}}</td>
    {{/with}}
  {{/if}}
  {{#if hasOutput}}
    {{#with OutputMetrics}}
      <td>{{formatBytes BytesWritten}}</td>
      <td>{{RecordsWritten}}</td>
    {{/with}}
  {{/if}}
  {{#if hasShuffleRead}}
    {{#with ShuffleReadMetrics}}
      <td>{{shuffleBytesReadStr this}}</td>
      <td>{{TotalRecordsRead}}</td>
    {{/with}}
  {{/if}}
  {{#if hasShuffleWrite}}
    {{#with ShuffleWriteMetrics}}
      <td>{{formatBytes ShuffleBytesWritten}}</td>
      <td>{{ShuffleRecordsWritten}}</td>
    {{/with}}
  {{/if}}
</template>

<template name="executorRow">
  <tr>
    <td>{{id}}</td>
    <td>{{>hostPort this}}</td>
    <td>{{taskTime id}}</td>

    {{#with taskCounts id}}
      <td>{{running}}</td>
      <td>{{#if failed}}{{failed}}{{else}}0{{/if}}</td>
      <td>{{succeeded}}</td>
      <td>{{num}}</td>
    {{/with}}

    {{>metricsColumns metrics}}
  </tr>
</template>

<template name="tasksTable">
  <h4>Tasks</h4>
  {{#with sorted taskAttempts}}
    {{>table data=this columns=columns}}
  {{/with}}
</template>

<template name="taskRow-index">
  {{index}}
</template>

<template name="taskRow-id">
  {{id}}
</template>

<template name="taskRow-attempt">
  {{attempt}}
</template>

<template name="taskRow-status">
  {{status this}}
</template>

<template name="taskRow-localityLevel">
  {{locality}}
</template>

<template name="taskRow-execId">
  {{execId}}
</template>

<template name="taskRow-host">
  {{getHost appId execId}}
</template>

<template name="taskRow-start">
  {{formatDateTime time.start}}
</template>

<template name="taskRow-duration">
  {{formatDuration time.start time.end}}
</template>

<template name="taskRow-gcTime">
  {{#if metrics.JVMGCTime}}{{formatTime metrics.JVMGCTime}}{{/if}}
</template>

<template name="taskRow-input">
  {{formatBytes metrics.InputMetrics.BytesRead}}
</template>

<template name="taskRow-inputRecords">
  {{formatBytes metrics.InputMetrics.RecordsRead}}
</template>

<template name="taskRow-output">
  {{formatBytes metrics.OutputMetrics.BytesWritten}}
</template>

<template name="taskRow-outputRecords">
  {{formatBytes metrics.OutputMetrics.RecordsWritten}}
</template>

<template name="taskRow-shuffleRead">
  {{shuffleBytesReadStr metrics.ShuffleReadMetrics}}
</template>

<template name="taskRow-shuffleReadRecords">
  {{metrics.ShuffleReadMetrics.TotalRecordsRead}}
</template>

<template name="taskRow-shuffleWrite">
  {{formatBytes metrics.ShuffleWriteMetrics.ShuffleBytesWritten}}
</template>

<template name="taskRow-shuffleWriteRecords">
  {{metrics.ShuffleWriteMetrics.ShuffleRecordsWritten}}
</template>

<template name="taskRow-errors">
  {{>fetchFailure end}}
  {{>exceptionFailure end}}
  {{>executorLostFailure end}}
</template>

<template name="fetchFailure">
  {{#if fetchFailure reason}}
    Fetch Failed, {{>hostPort BlockManagerAddress}}: {{message}}<br/>
    Shuffle ID: {{ShuffleID}}<br/>
    Map ID: {{MapID}}<br/>
    Reduce ID: {{ReduceID}}
  {{/if}}
</template>

<template name="exceptionFailure">
  {{#if exceptionFailure reason}}
    {{ClassName}}: {{Description}}<br/>
    {{FullStackTrace}}
    {{>stackTrace StackTrace}}
  {{/if}}
</template>

<template name="stackTrace">
  {{#each this}}
    {{DeclaringClass}}.{{MethodName}} ({{FileName}}:{{LineNumber}})
  {{/each}}
</template>

<template name="executorLostFailure">
  {{#if executorLostFailure reason}}
    {{reason}}: {{ExecutorID}} ({{getHostPort ExecutorID}}
  {{/if}}
</template>

