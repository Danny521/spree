
<template name="stagePage">
  {{>navbar}}
  {{setTitle this}}
  {{log this}}
  <div class="container-fluid">
    <h3>Details for Stage {{stage.id}}, Attempt {{stageAttempt.id}}</h3>
    {{#with stageAttempt.metrics}}
      <div><strong>Total time across all tasks:</strong> {{formatTime ExecutorRunTime}}</div>

      {{#with InputMetrics}}
        {{#if hasInput}}
        <div>
          <strong>Input Size / Records:</strong> {{formatBytes BytesRead}} / {{RecordsRead}} records
        </div>
        {{/if}}
      {{/with}}

      {{#with OutputMetrics}}
        {{#if hasOutput}}
        <div>
          <strong>Output Size / Records:</strong> {{formatBytes BytesWritten}} / {{RecordsWritten}} records
        </div>
        {{/if}}
      {{/with}}

      {{#with ShuffleReadMetrics}}
        {{#if hasShuffleRead}}
        <div>
          <strong>Shuffle read:</strong> {{shuffleBytesReadStr this}} / {{TotalRecordsRead}} records
        </div>
        {{/if}}
      {{/with}}

      {{#with ShuffleWriteMetrics}}
        {{#if hasShuffleWrite}}
        <div>
          <strong>Shuffle write:</strong> {{formatBytes ShuffleBytesWritten}} / {{ShuffleRecordsWritten}} records
        </div>
        {{/if}}
      {{/with}}
    {{/with}}

    {{> summaryMetricsTable this}}
    {{> executorTable this}}
    {{> tasksTable this}}
  </div>
</template>

<template name="summaryMetricsTable">
  {{#with stage.taskCounts}}
    <h4>
      Summary Metrics for {{numCompletedTasks this}} Completed Tasks
      ({{num}} total,
        {{running}} active,
        {{#if failed}}{{failed}}{{else}}0{{/if}} failed,
        {{#if succeeded}}{{succeeded}}{{else}}0{{/if}} succeeded)
    </h4>
  {{/with}}
  <table class="table table-bordered table-striped table-condensed sortable">
    <thead>
    <tr>
      <th>Metric</th>
      <th>Min</th>
      <th>25th Percentile</th>
      <th>Median</th>
      <th>75th Percentile</th>
      <th>Max</th>
    </tr>
    </thead>
    <tbody>
    {{> summaryRow durations}}
    </tbody>
  </table>
</template>

<template name="hostPort">
  {{host}}:{{port}}
</template>

<template name="summaryRow">
  <tr>
    <td>{{name}}</td>
    <td>{{stats.[0]}}</td>
    <td>{{stats.[1]}}</td>
    <td>{{stats.[2]}}</td>
    <td>{{stats.[3]}}</td>
    <td>{{stats.[4]}}</td>
  </tr>
</template>

<template name="executorTable">
  <h4>Aggregated Metrics by Executor</h4>
  <table class="table table-bordered table-striped table-condensed sortable">
    <thead>
    <tr>
      <th>Executor ID</th>
      <th>Address</th>
      <th>Task Time</th>
      <th>Active Tasks</th>
      <th>Failed Tasks</th>
      <th>Succeeded Tasks</th>
      <th>Total Tasks</th>
      {{>metricsHeaders}}
    </tr>
    </thead>
    <tbody>
    {{#each executors}}
      {{>executorRow}}
    {{/each}}
    </tbody>
  </table>
</template>

<template name="metricsHeaders">
  {{#if hasInput}}
    <th>Input Size</th>
    <th>…Records</th>
  {{/if}}
  {{#if hasOutput}}
    <th>Output Size</th>
    <th>…Records</th>
  {{/if}}
  {{#if hasShuffleRead}}
    <th>Shuffle Read Size</th>
    <th>…Records</th>
  {{/if}}
  {{#if hasShuffleWrite}}
    <th>Shuffle Write Size</th>
    <th>…Records</th>
  {{/if}}
</template>

<template name="metricsColumns">
  {{#if hasInput}}
    {{#with InputMetrics}}
      <td>{{formatBytes BytesRead}}</td>
      <td>{{RecordsRead}}</td>
    {{/with}}
  {{/if}}
  {{#if hasOutput}}
    {{#with OutputMetrics}}
      <td>{{formatBytes BytesWritten}}</td>
      <td>{{RecordsWritten}}</td>
    {{/with}}
  {{/if}}
  {{#if hasShuffleRead}}
    {{#with ShuffleReadMetrics}}
      <td>{{shuffleBytesReadStr this}}</td>
      <td>{{TotalRecordsRead}}</td>
    {{/with}}
  {{/if}}
  {{#if hasShuffleWrite}}
    {{#with ShuffleWriteMetrics}}
      <td>{{formatBytes ShuffleBytesWritten}}</td>
      <td>{{ShuffleRecordsWritten}}</td>
    {{/with}}
  {{/if}}
</template>

<template name="executorRow">
  <tr>
    <td>{{id}}</td>
    <td>{{>hostPort this}}</td>
    <td>{{taskTime id}}</td>

    {{#with taskCounts id}}
      <td>{{running}}</td>
      <td>{{#if failed}}{{failed}}{{else}}0{{/if}}</td>
      <td>{{succeeded}}</td>
      <td>{{num}}</td>
    {{/with}}

    {{>metricsColumns metrics}}
  </tr>
</template>

<template name="tasksTable">
  <h4>Tasks</h4>
  <table class="table table-bordered table-striped table-condensed sortable">
    <thead>
    <tr>
      <th>Index</th>
      <th>ID</th>
      <th>Attempt</th>
      <th>Status</th>
      <th>Locality Level</th>
      <th>Exec ID</th>
      <th>Host</th>
      <th>Launch Time</th>
      <th>Duration</th>
      <th>GC Time</th>
      {{>metricsHeaders}}
      <th>Errors</th>
    </tr>
    </thead>
    <tbody>
    {{#each taskAttempts}}
    <tr>
      <td>{{index}}</td>
      <td>{{id}}</td>
      <td>{{attempt}}</td>
      <td>{{status this}}</td>
      <td>{{locality}}</td>
      <td>{{execId}}</td>
      <td>{{getHost appId execId}}</td>
      <td>{{formatDateTime time.start}}</td>

      {{#with metrics}}
        <td>{{formatTime ExecutorRunTime}}</td>
        <td>{{#if JVMGCTime}}{{JVMGCTime}}{{/if}}</td>
        {{>metricsColumns this}}
      {{/with}}

      <td>
        {{>fetchFailure end}}
        {{>exceptionFailure end}}
        {{>executorLostFailure end}}
      </td>
    </tr>
    {{/each}}
    </tbody>
  </table>
</template>

<template name="fetchFailure">
  {{#if fetchFailure reason}}
    Fetch Failed, {{>hostPort BlockManagerAddress}}: {{message}}<br/>
    Shuffle ID: {{ShuffleID}}<br/>
    Map ID: {{MapID}}<br/>
    Reduce ID: {{ReduceID}}
  {{/if}}
</template>

<template name="exceptionFailure">
  {{#if exceptionFailure reason}}
    {{ClassName}}: {{Description}}<br/>
    {{FullStackTrace}}
    {{>stackTrace StackTrace}}
  {{/if}}
</template>

<template name="stackTrace">
  {{#each this}}
    {{DeclaringClass}}.{{MethodName}} ({{FileName}}:{{LineNumber}})
  {{/each}}
</template>

<template name="executorLostFailure">
  {{#if executorLostFailure reason}}
    {{reason}}: {{ExecutorID}} ({{getHostPort ExecutorID}}
  {{/if}}
</template>

