<head>
  <title>Spark Jobs</title>
</head>

<template name="navbar">
  <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="brand">
        <a href="/" class="brand">
          <img src="/img/spark-logo-77x50px-hd.png" />
          <span class="version">1.3.1</span>
        </a>
      </div>
      <ul class="nav">
        <li class="{{#if jobsTab}}active{{/if}}">
          <a href="/a/{{appId}}">Jobs</a>
        </li>
        <li class="{{#if stagesTab}}active{{/if}}"><a href="/a/{{appId}}/stages">Stages</a></li>
        <li class="{{#if storageTab}}active{{/if}}"><a href="/a/{{appId}}/storage">Storage</a></li>
        <li class="{{#if envTab}}active{{/if}}"><a href="/a/{{appId}}/environment">Environment</a></li>
        <li class="{{#if executorsTab}}active{{/if}}"><a href="/a/{{appId}}/executors">Executors</a></li>
      </ul>
      <div id="mongoUrlContainer" class="navbar-text pull-right">Mongo: <span id="mongoUrl">{{mongoUrl}}</span></div>
    </div>
  </div>
</template>

<template name="appsPage">
  {{>navbar}}
  <div class="container-fluid">
    <h3>Spark Applications</h3>
    <table class="table table-bordered table-striped table-condensed sortable">
      <thead>
        <tr>
          <th>App ID</th>
          <th>App Name</th>
          <th>Started</th>
          <th>Completed</th>
          <th>Duration</th>
          <th>User</th>
        </tr>
      </thead>
      <tbody>
        {{#each applications}}
          <tr>
            <td><a href="/a/{{id}}">{{id}}</a></td>
            <td>{{name}}</td>
            <td>{{formatDateTime time.start}}</td>
            <td>{{formatDateTime time.end}}</td>
            <td>{{formatDuration time.start time.end}}</td>
            <td>{{user}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  </div>
</template>

<template name="jobsPage">
  {{>navbar}}
  {{log this}}
  <div class="container-fluid">
    <h3>Spark Jobs</h3>
    <div><strong>Total Duration:</strong> TODO</div>
    <div><strong>Scheduling Mode:</strong> TODO</div>
    <div><a href="#completed"><strong>Completed Jobs:</strong></a> TODO</div>

    <h4 id="completed">Completed Jobs</h4>
    <table class="table table-bordered table-striped table-condensed sortable">
      <thead>
      <tr>
        <th>Job Id</th>
        <th>Description</th>
        <th>Submitted</th>
        <th>Duration</th>
        <th>Stages: Succeeded/Total</th>
        <th>Tasks (all stages): Succeeded/Total</th>
      </tr>
      </thead>
      <tbody>
      {{#each jobs}}
      <tr class="{{rowClass this}}">
        <td>{{id}}</td>
        <td><a href="/a/{{appId}}/job/{{id}}">{{getJobName this}}</a></td>
        <td>{{formatDateTime time.start}}</td>
        <td>{{getJobDuration this}}</td>
        <td>{{> progressBar stageCounts}}</td>
        <td>{{> progressBar taskCounts}}</td>
      </tr>
      {{/each}}
      </tbody>
    </table>
  </div>
</template>

<template name="jobPage">
  {{>navbar}}
  {{log this}}
  <div class="container-fluid">
    <h3>Details for Job {{job.id}}</h3>
    <div><strong>Status:</strong> {{jobStatus job}}</div>
    {{>stagesTables}}
  </div>
</template>

<template name="stageRow">
  <tr class="{{getClass this}}">
    <td>{{id}}</td>
    <td><a href="/a/{{appId}}/stage/{{id}}?attempt={{attempt}}">{{name}}</a></td>
    <td>{{formatDateTime time.start}}</td>
    <td>{{formatDuration time.start time.end}}</td>
    <td>{{> progressBar taskCounts}}</td>
    <td>{{formatBytes metrics.inputMetrics.bytesRead}}</td>
    <td>{{formatBytes metrics.outputMetrics.bytesWritten}}</td>
    <td>{{shuffleRead metrics.shuffleReadMetrics}}</td>
    <td>{{formatBytes metrics.shuffleWriteMetrics.shuffleBytesWritten}}</td>
  </tr>
</template>

<template name="progressBar">
  <div class="progress">
    <span class="progress-label">{{label this}}</span>
    <div class="bar bar-completed" style="width:{{completedPercentage this}}"></div>
    <div class="bar bar-running" style="width:{{runningPercentage this}}"></div>
  </div>
</template>

<template name="stagesPage">
  {{>navbar}}
  {{log this}}
  <div class="container-fluid">
    <h3>Spark Stages (for all jobs)</h3>
    <div><strong>Scheduling Mode:</strong> TODO</div>
    {{> stagesTables}}
  </div>
</template>

<template name="stagesTables">
  {{#if numActiveStages}}<div><a href="#active"><strong>Active Stages:</strong></a> {{numActiveStages}}</div>{{/if}}
  {{#if numPendingStages}}<div><a href="#pending"><strong>Pending Stages:</strong></a> {{numPendingStages}}</div>{{/if}}
  {{#if numCompletedStages}}<div><a href="#completed"><strong>Completed Stages:</strong></a> {{numCompletedStages}}</div>{{/if}}
  {{#if numSkippedStages}}<div><a href="#skipped"><strong>Skipped Stages:</strong></a> {{numSkippedStages}}</div>{{/if}}
  {{#if numActiveStages}}
    <h4 id="active">Active Stages ({{numActiveStages}})</h4>
    {{>stagesTable activeStages}}
  {{/if}}
  {{#if numPendingStages}}
    <h4 id="pending">Pending Stages ({{numPendingStages}})</h4>
    {{>stagesTable pendingStages}}
  {{/if}}
  {{#if numCompletedStages}}
    <h4 id="completed">Completed Stages ({{numCompletedStages}})</h4>
    {{>stagesTable completedStages}}
  {{/if}}
  {{#if numSkippedStages}}
    <h4 id="skipped">Skipped Stages ({{numSkippedStages}})</h4>
    {{>stagesTable skippedStages}}
  {{/if}}
</template>

<template name="stagesTable">
  <table class="table table-bordered table-striped table-condensed sortable">
    <thead>
    <tr>
      <th>Stage ID</th>
      <th>Description</th>
      <th>Submitted</th>
      <th>Duration</th>
      <th>Tasks: Suceeded/Total</th>
      <th>Input</th>
      <th>Output</th>
      <th>Shuffle Read</th>
      <th>Shuffle Write</th>
    </tr>
    </thead>
    <tbody>
      {{#each this}}
        {{> stageRow this}}
      {{/each}}
    </tbody>
  </table>
</template>

<template name="stagePage">
  {{>navbar}}
  {{log this}}
  <div class="container-fluid">
    <h3>Details for Stage {{stage.id}}, Attempt {{stage.attempt}}</h3>
    <div><strong>Total time across all tasks:</strong> {{totalTime tasks}}</div>

    {{#with stage.metrics.inputMetrics}}
      {{#if shouldShow bytesRead recordsRead}}
      <div>
        <strong>Input Size / Records:</strong> {{formatBytes bytesRead}} / {{recordsRead}}
      </div>
      {{/if}}
    {{/with}}

    {{#with stage.metrics.outputMetrics}}
      {{#if shouldShow bytesWritten recordsWritten}}
      <div>
        <strong>Output Size / Records:</strong> {{formatBytes bytesWritten}} / {{recordsWritten}}
      </div>
      {{/if}}
    {{/with}}

    {{#with stage.metrics.shuffleReadMetrics}}
    {{#if shouldShow shuffleBytesRead shuffleRecordsRead}}
      <div>
        <strong>Shuffle read:</strong> {{formatBytes shuffleBytesRead}} / {{shuffleRecordsRead}}
      </div>
      {{/if}}
    {{/with}}

    {{#with stage.metrics.shuffleWriteMetrics}}
      {{#if shouldShow shuffleBytesWritten shuffleRecordsWritten}}
      <div>
        <strong>Shuffle write:</strong> {{formatBytes shuffleBytesWritten}} / {{shuffleRecordsWritten}}
      </div>
      {{/if}}
    {{/with}}
    <h4>Summary Metrics for {{numCompletedTasks stage.taskCounts}} Completed Tasks</h4>
    <table class="table table-bordered table-striped table-condensed sortable">
      <thead>
      <tr>
        <th>Metric</th>
        <th>Min</th>
        <th>25th Percentile</th>
        <th>Median</th>
        <th>75th Percentile</th>
        <th>Max</th>
      </tr>
      </thead>
      <tbody>
       {{> summaryRow durations}}
      </tbody>
    </table>

    <h4>Aggregated Metrics by Executor</h4>
    <table class="table table-bordered table-striped table-condensed sortable">
      <thead>
      <tr>
        <th>Executor ID</th>
        <th>Address</th>
        <th>Task Time</th>
        <th>Total Tasks</th>
        <th>Failed Tasks</th>
        <th>Succeeded Tasks</th>
        <th>Input Size / Records</th>
      </tr>
      </thead>
      <tbody>

      </tbody>
    </table>

    <h4>Tasks</h4>
    <table class="table table-bordered table-striped table-condensed sortable">
      <thead>
      <tr>
        <th>Index</th>
        <th>ID</th>
        <th>Attempt</th>
        <th>Status</th>
        <th>Locality Level</th>
        <th>Exec ID</th>
        <th>Host</th>
        <th>Launch Time</th>
        <th>Duration</th>
        <th>GC Time</th>
        <th>Input Size / Records</th>
        <th>Errors</th>
      </tr>
      </thead>
      <tbody>
        {{#each tasks}}
          <tr>
            <td>{{index}}</td>
            <td>{{id}}</td>
            <td>{{attempt}}</td>
            <td>{{status this}}</td>
            <td>{{localityLevel taskLocality}}</td>
            <td>{{execId}}</td>
            <td>{{#with lastMetrics this}}{{hostname}}{{/with}}</td>
            <td>{{formatDateTime time.start}}</td>
            <td>{{formatDuration time.start time.end true}}</td>
            {{#with lastMetrics this}}
              <td>{{#if jvmGCTime}}{{jvmGCTime}}{{/if}}</td>
              <td>
                {{#with inputMetrics}}
                  {{#if shouldShow bytesRead recordsRead}}
                    {{formatBytes bytesRead}} / {{recordsRead}}
                  {{/if}}
                {{/with}}
              </td>
            {{/with}}
            <td>{{reason taskEndReason}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  </div>
</template>

<template name="summaryRow">
  <tr>
    <td>{{name}}</td>
    <td>{{stats.[0]}}</td>
    <td>{{stats.[1]}}</td>
    <td>{{stats.[2]}}</td>
    <td>{{stats.[3]}}</td>
    <td>{{stats.[4]}}</td>
  </tr>
</template>

<template name="storagePage">
  {{>navbar}}
  {{log this}}
  <div class="container-fluid">
    <h3>Storage</h3>
    <table class="table table-bordered table-striped table-condensed sortable">
      <thead>
      <tr>
        <th>RDD Name (ID)</th>
        <th>Storage Level</th>
        <th>Cached Partitions</th>
        <th>Fraction Cached</th>
        <th>Size in Memory</th>
        <th>Size in Tachyon</th>
        <th>Size on Disk</th>
      </tr>
      </thead>
      <tbody>
      {{#each rdds}}
      <tr>
        <td><a href="/a/{{../appId}}/rdd/{{id}}">{{name}} ({{id}})</a></td>
        <td>{{getStorageLevel storageLevel}}</td>
        <td>{{numCachedPartitions}}</td>
        <td>{{cachedFraction}}</td>
        <td>{{formatBytes memSize}}</td>
        <td>{{formatBytes tachyonSize}}</td>
        <td>{{formatBytes diskSize}}</td>
      </tr>
      {{/each}}
      </tbody>
    </table>
  </div>
</template>

<template name="environmentPage">
  {{>navbar}}
  {{log this}}
  <div class="container-fluid">
    <h3>Environment</h3>
    <h4>Runtime Information</h4>
    <table class="table table-bordered table-striped table-condensed sortable">
      <thead>
      <tr>
        <th>Name</th>
        <th>Value</th>
      </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <h4>Spark Properties</h4>
    <h4>System Properties</h4>
    <h4>Classpath Entries</h4>
  </div>
</template>

<template name="environmentTable">
  <table class="table table-bordered table-striped table-condensed sortable">
    <thead>
    <tr>
      <th>Name</th>
      <th>Value</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</template>
